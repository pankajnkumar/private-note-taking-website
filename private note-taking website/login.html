<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login & Registration</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script src="user-database.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .form-container.hidden {
            display: none;
        }
        .form-container {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Custom focus styles for better accessibility and design */
        .form-input:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5); /* blue-500 with 50% opacity */
            border-color: #3B82F6; /* blue-500 */
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

    <div class="w-full max-w-md mx-auto p-4">
        <div class="bg-white rounded-2xl shadow-lg p-8">
            
            <!-- Header Tabs -->
            <div class="flex border-b border-gray-200 mb-6">
                <button id="login-tab" class="flex-1 py-3 text-center font-semibold text-blue-600 border-b-2 border-blue-600 transition-colors duration-300">Login</button>
                <button id="register-tab" class="flex-1 py-3 text-center font-semibold text-gray-500 transition-colors duration-300">Register</button>
            </div>

            <!-- Message Area -->
            <div id="message-area" class="hidden p-3 mb-4 text-sm rounded-lg text-center"></div>

            <!-- Login Form -->
            <div id="login-form" class="form-container">
                <h2 class="text-2xl font-bold text-gray-800 text-center mb-1">Welcome Back!</h2>
                <p class="text-gray-500 text-center mb-6">Login to continue to your account.</p>
                <form id="login-form-element">
                    <div class="mb-4">
                        <label for="login-email" class="block text-gray-700 text-sm font-medium mb-2">Email or Phone</label>
                        <input type="text" id="login-email" name="email" placeholder="you@example.com" class="form-input w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg transition-all" required>
                    </div>
                    <div class="mb-6">
                        <label for="login-password" class="block text-gray-700 text-sm font-medium mb-2">Password</label>
                        <input type="password" id="login-password" name="password" placeholder="••••••••" class="form-input w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg transition-all" required>
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition-all duration-300 transform hover:scale-105">
                        Sign In
                    </button>
                    <div class="text-center mt-4">
                        <button type="button" id="forgot-password-btn" class="text-blue-600 hover:text-blue-800 text-sm font-medium hover:underline">
                            Forgot Password?
                        </button>
                    </div>
                </form>
            </div>

            <!-- Registration Form -->
            <div id="register-form" class="form-container hidden">
                <h2 class="text-2xl font-bold text-gray-800 text-center mb-1">Create an Account</h2>
                <p class="text-gray-500 text-center mb-6">Get started by creating your new account.</p>
                <form id="register-form-element">
                    <div class="mb-4">
                        <label for="register-name" class="block text-gray-700 text-sm font-medium mb-2">Full Name</label>
                        <input type="text" id="register-name" name="name" placeholder="John Doe" class="form-input w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg transition-all" required>
                    </div>
                    <div class="mb-4">
                        <label for="register-company" class="block text-gray-700 text-sm font-medium mb-2">Company Name</label>
                        <input type="text" id="register-company" name="company" placeholder="Acme Inc." class="form-input w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg transition-all" required>
                    </div>
                    <div class="mb-4">
                        <label for="register-role" class="block text-gray-700 text-sm font-medium mb-2">Role</label>
                        <select id="register-role" name="role" class="form-input w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg transition-all" required>
                            <option value="member" selected>Member</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label for="register-email" class="block text-gray-700 text-sm font-medium mb-2">Email or Phone</label>
                        <input type="text" id="register-email" name="email" placeholder="you@example.com" class="form-input w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg transition-all" required>
                    </div>
                    <div class="mb-4">
                        <label for="register-password" class="block text-gray-700 text-sm font-medium mb-2">Password</label>
                        <input type="password" id="register-password" name="password" placeholder="••••••••" class="form-input w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg transition-all" required>
                    </div>
                    <div class="mb-6">
                        <label for="register-confirm-password" class="block text-gray-700 text-sm font-medium mb-2">Confirm Password</label>
                        <input type="password" id="register-confirm-password" name="confirmPassword" placeholder="••••••••" class="form-input w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg transition-all" required>
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition-all duration-300 transform hover:scale-105">
                        Create Account
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- OTP Modal -->
    <div id="otp-modal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-lg p-8 max-w-sm w-full text-center form-container">
            <h2 class="text-2xl font-bold text-gray-800 mb-2">Verify Your Account</h2>
            <p class="text-gray-500 mb-6">An OTP has been sent to your email. Please enter it below.</p>
            <form id="otp-form-element">
                <div class="flex justify-center gap-2 mb-6">
                    <input type="text" maxlength="1" class="otp-input w-12 h-14 text-center text-2xl font-semibold border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all">
                    <input type="text" maxlength="1" class="otp-input w-12 h-14 text-center text-2xl font-semibold border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all">
                    <input type="text" maxlength="1" class="otp-input w-12 h-14 text-center text-2xl font-semibold border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all">
                    <input type="text" maxlength="1" class="otp-input w-12 h-14 text-center text-2xl font-semibold border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all">
                    <input type="text" maxlength="1" class="otp-input w-12 h-14 text-center text-2xl font-semibold border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all">
                    <input type="text" maxlength="1" class="otp-input w-12 h-14 text-center text-2xl font-semibold border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all">
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition-all duration-300 transform hover:scale-105">
                    Verify
                </button>
            </form>
            <p class="text-sm text-gray-500 mt-4">
                Didn't receive the code? 
                <button id="resend-otp" class="font-semibold text-blue-600 hover:underline">Resend OTP</button>
            </p>
        </div>
    </div>

    <!-- Forgot Password Modal -->
    <div id="forgot-password-modal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-lg p-8 max-w-sm w-full text-center form-container">
            <h2 class="text-2xl font-bold text-gray-800 mb-2">Reset Password</h2>
            <p class="text-gray-500 mb-6">Enter your email address and we'll send you a password reset code.</p>
            <form id="forgot-password-form-element">
                <div class="mb-6">
                    <label for="reset-email" class="block text-gray-700 text-sm font-medium mb-2">Email Address</label>
                    <input type="email" id="reset-email" name="email" placeholder="you@example.com" class="form-input w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg transition-all" required>
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition-all duration-300 transform hover:scale-105">
                    Send Reset Code
                </button>
            </form>
            <button id="close-forgot-modal" class="mt-4 text-gray-500 hover:text-gray-700 text-sm">
                Back to Login
            </button>
        </div>
    </div>

    <!-- Reset Password with Code Modal -->
    <div id="reset-password-modal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-lg p-8 max-w-sm w-full text-center form-container">
            <h2 class="text-2xl font-bold text-gray-800 mb-2">Enter Reset Code</h2>
            <p class="text-gray-500 mb-6">Enter the 6-digit code sent to your email and your new password.</p>
            <form id="reset-password-form-element">
                <div class="mb-4">
                    <label for="reset-code" class="block text-gray-700 text-sm font-medium mb-2">Reset Code</label>
                    <div class="flex justify-center gap-2 mb-4">
                        <input type="text" maxlength="1" class="reset-code-input w-10 h-12 text-center text-xl font-semibold border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all">
                        <input type="text" maxlength="1" class="reset-code-input w-10 h-12 text-center text-xl font-semibold border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all">
                        <input type="text" maxlength="1" class="reset-code-input w-10 h-12 text-center text-xl font-semibold border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all">
                        <input type="text" maxlength="1" class="reset-code-input w-10 h-12 text-center text-xl font-semibold border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all">
                        <input type="text" maxlength="1" class="reset-code-input w-10 h-12 text-center text-xl font-semibold border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all">
                        <input type="text" maxlength="1" class="reset-code-input w-10 h-12 text-center text-xl font-semibold border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all">
                    </div>
                </div>
                <div class="mb-4">
                    <label for="new-password" class="block text-gray-700 text-sm font-medium mb-2">New Password</label>
                    <input type="password" id="new-password" name="password" placeholder="••••••••" class="form-input w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg transition-all" required>
                </div>
                <div class="mb-6">
                    <label for="confirm-password" class="block text-gray-700 text-sm font-medium mb-2">Confirm Password</label>
                    <input type="password" id="confirm-password" name="confirmPassword" placeholder="••••••••" class="form-input w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg transition-all" required>
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition-all duration-300 transform hover:scale-105">
                    Reset Password
                </button>
            </form>
            <p class="text-sm text-gray-500 mt-4">
                Didn't receive the code? 
                <button id="resend-reset-code" class="font-semibold text-blue-600 hover:underline">Resend Code</button>
            </p>
            <button id="close-reset-modal" class="mt-2 text-gray-500 hover:text-gray-700 text-sm">
                Back to Login
            </button>
        </div>
    </div>

    <script>
        // Initialize EmailJS
        (function() {
            emailjs.init("WOOBuV_HR9geoF8lL"); // You'll need to replace this with your EmailJS public key
        })();

        const loginTab = document.getElementById('login-tab');
        const registerTab = document.getElementById('register-tab');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        
        const loginFormElement = document.getElementById('login-form-element');
        const registerFormElement = document.getElementById('register-form-element');
        const otpFormElement = document.getElementById('otp-form-element');

        const otpModal = document.getElementById('otp-modal');
        const messageArea = document.getElementById('message-area');
        const resendOtpBtn = document.getElementById('resend-otp');

        // Forgot password elements
        const forgotPasswordBtn = document.getElementById('forgot-password-btn');
        const forgotPasswordModal = document.getElementById('forgot-password-modal');
        const resetPasswordModal = document.getElementById('reset-password-modal');
        const forgotPasswordForm = document.getElementById('forgot-password-form-element');
        const resetPasswordForm = document.getElementById('reset-password-form-element');
        const closeForgotModal = document.getElementById('close-forgot-modal');
        const closeResetModal = document.getElementById('close-reset-modal');
        const resendResetCodeBtn = document.getElementById('resend-reset-code');

        // Store user data and OTP
        let currentUserData = null;
        let currentOTP = null;
        let otpExpiry = null;

        // Store reset password data
        let resetUserEmail = null;
        let resetCode = null;
        let resetCodeExpiry = null;

        // --- Tab Switching Logic ---
        loginTab.addEventListener('click', () => {
            loginTab.classList.add('text-blue-600', 'border-blue-600');
            loginTab.classList.remove('text-gray-500');
            registerTab.classList.add('text-gray-500');
            registerTab.classList.remove('text-blue-600', 'border-blue-600');
            
            registerForm.classList.add('hidden');
            loginForm.classList.remove('hidden');
            messageArea.classList.add('hidden');
        });

        registerTab.addEventListener('click', () => {
            registerTab.classList.add('text-blue-600', 'border-blue-600');
            registerTab.classList.remove('text-gray-500');
            loginTab.classList.add('text-gray-500');
            loginTab.classList.remove('text-blue-600', 'border-blue-600');

            loginForm.classList.add('hidden');
            registerForm.classList.remove('hidden');
            messageArea.classList.add('hidden');
        });

        // Open register tab if query param tab=register is present
        (function() {
            const params = new URLSearchParams(window.location.search);
            if ((params.get('tab') || '').toLowerCase() === 'register') {
                registerTab.click();
            }
        })();

        // --- Message Display Logic ---
        function showMessage(type, text) {
            messageArea.textContent = text;
            messageArea.className = 'p-3 mb-4 text-sm rounded-lg text-center'; // Reset classes
            if (type === 'success') {
                messageArea.classList.add('bg-green-100', 'text-green-800');
            } else if (type === 'error') {
                messageArea.classList.add('bg-red-100', 'text-red-800');
            }
            messageArea.classList.remove('hidden');
        }

        // --- OTP Generation and Email Functions ---
        function generateOTP() {
            return Math.floor(100000 + Math.random() * 900000).toString();
        }

        function sendOTPEmail(email, otp, userName) {
            const templateParams = {
                to_email: email,
                to_name: userName,
                otp_code: otp,
                from_name: 'DeFiLaunch Team',
                reply_to: email,
                message: `Your OTP code is: ${otp}. This code will expire in 10 minutes.`
            };

            console.log('Sending email with params:', templateParams);

            return emailjs.send('service_nufodsu', 'template_6d6fjtp', templateParams)
                .then(function(response) {
                    console.log('OTP Email sent successfully!', response.status, response.text);
                    return true;
                }, function(error) {
                    console.error('Failed to send OTP email:', error);
                    console.error('Error details:', {
                        status: error.status,
                        text: error.text,
                        templateParams: templateParams
                    });
                    return false;
                });
        }

        function isOTPExpired() {
            return otpExpiry && new Date() > otpExpiry;
        }

        // Test function to verify EmailJS setup
        function testEmailJS() {
            console.log('Testing EmailJS connection...');
            
            const testParams = {
                to_email: 'test@example.com',
                to_name: 'Test User',
                otp_code: '123456',
                from_name: 'DeFiLaunch Team',
                reply_to: 'test@example.com'
            };

            emailjs.send('service_nufodsu', 'template_6d6fjtp', testParams)
                .then(function(response) {
                    console.log('✅ EmailJS test successful!', response);
                }, function(error) {
                    console.error('❌ EmailJS test failed:', error);
                    console.error('Check your EmailJS configuration:');
                    console.error('1. Service ID: service_nufodsu');
                    console.error('2. Template ID: template_6d6fjtp');
                    console.error('3. Template variables must match:', Object.keys(testParams));
                });
        }

        // Uncomment the line below to test EmailJS when page loads
        // testEmailJS();

        // --- Form Submission Simulation ---
        // In a real application, you would replace the setTimeout with a `fetch` call to your backend API.
        
        loginFormElement.addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = new FormData(loginFormElement);
            const email = formData.get('email');
            const password = formData.get('password');
            
            console.log('Attempting to log in with:', email);

            // Validate input
            if (!email || !password) {
                showMessage('error', 'Please enter both email and password.');
                return;
            }

            // Attempt login using database
            const loginResult = userDB.loginUser(email, password);
            
            if (loginResult.success) {
                showMessage('success', 'Login successful! Redirecting to teams...');
                
                // Redirect to teams after a short delay
                setTimeout(() => {
                    window.location.href = 'teams.html';
                }, 1500);
            } else {
                showMessage('error', loginResult.message);
            }
        });

        registerFormElement.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(registerFormElement);
            const name = formData.get('name');
            const company = formData.get('company');
            const role = formData.get('role');
            const email = formData.get('email');
            const password = formData.get('password');
            const confirmPassword = formData.get('confirmPassword');
            
            console.log('Attempting to register with:', email);
            
            // Validate password confirmation
            if (password !== confirmPassword) {
                showMessage('error', 'Password and confirm password must match.');
                // visual feedback
                const confirmEl = document.getElementById('register-confirm-password');
                confirmEl.classList.add('ring-2','ring-red-400');
                setTimeout(() => confirmEl.classList.remove('ring-2','ring-red-400'), 1000);
                return;
            }

            // Register user in database
            const registrationResult = userDB.registerUser({ name, companyName: company, email, password, role });
            
            if (!registrationResult.success) {
                showMessage('error', registrationResult.message);
                return;
            }
            
            // Store user data for OTP verification
            currentUserData = { name, companyName: company, email, password, role };
            
            // Generate OTP
            currentOTP = generateOTP();
            otpExpiry = new Date(Date.now() + 10 * 60 * 1000); // 10 minutes from now
            
            showMessage('success', 'Registration successful! Sending OTP to your email...');
            
            try {
                const emailSent = await sendOTPEmail(email, currentOTP, name);
                
                if (emailSent) {
                    showMessage('success', 'OTP sent successfully! Please check your email.');
                    setTimeout(() => {
                        messageArea.classList.add('hidden');
                        otpModal.classList.remove('hidden');
                    }, 1500);
                } else {
                    showMessage('error', 'Failed to send OTP. Please try again.');
                }
            } catch (error) {
                console.error('Error sending OTP:', error);
                showMessage('error', 'Failed to send OTP. Please check your email and try again.');
            }
        });
        
        otpFormElement.addEventListener('submit', (e) => {
            e.preventDefault();
            const inputs = document.querySelectorAll('.otp-input');
            const otp = Array.from(inputs).map(input => input.value).join('');
            
            if (otp.length !== 6) {
                showMessage('error', 'Please enter the full 6-digit OTP.');
                return;
            }

            if (isOTPExpired()) {
                showMessage('error', 'OTP has expired. Please request a new one.');
                return;
            }

            console.log('Verifying OTP:', otp);

            if (otp === currentOTP) {
                otpModal.classList.add('hidden');
                
                // Verify user in database and log them in
                const verificationResult = userDB.updateUserAfterVerification(currentUserData.email, currentUserData);
                
                if (verificationResult.success) {
                    showMessage('success', 'Account verified successfully! Redirecting to teams...');
                    
                    // Redirect to teams after successful verification
                    setTimeout(() => {
                        window.location.href = 'teams.html';
                    }, 1500);
                } else {
                    showMessage('error', 'Verification failed. Please try again.');
                }
                
                // Clear OTP data
                currentOTP = null;
                otpExpiry = null;
                currentUserData = null;
                
                // Clear OTP inputs
                inputs.forEach(input => input.value = '');
            } else {
                showMessage('error', 'Invalid OTP. Please try again.');
                // Clear OTP inputs
                inputs.forEach(input => input.value = '');
                inputs[0].focus();
            }
        });

        // Resend OTP functionality
        resendOtpBtn.addEventListener('click', async () => {
            if (!currentUserData) {
                showMessage('error', 'No user data found. Please register again.');
                return;
            }

            // Generate new OTP
            currentOTP = generateOTP();
            otpExpiry = new Date(Date.now() + 10 * 60 * 1000); // 10 minutes from now

            try {
                const emailSent = await sendOTPEmail(currentUserData.email, currentOTP, currentUserData.name);
                
                if (emailSent) {
                    showMessage('success', 'New OTP sent successfully! Please check your email.');
                    // Clear OTP inputs
                    const inputs = document.querySelectorAll('.otp-input');
                    inputs.forEach(input => input.value = '');
                    inputs[0].focus();
                } else {
                    showMessage('error', 'Failed to send new OTP. Please try again.');
                }
            } catch (error) {
                console.error('Error resending OTP:', error);
                showMessage('error', 'Failed to send new OTP. Please try again.');
            }
        });

        // --- OTP Input Auto-Focus Logic ---
        const otpInputs = document.querySelectorAll('.otp-input');
        otpInputs.forEach((input, index) => {
            input.addEventListener('keyup', (event) => {
                if (event.key >= 0 && event.key <= 9) {
                    // Move to next input if a number is entered
                    if (index < otpInputs.length - 1) {
                        otpInputs[index + 1].focus();
                    }
                } else if (event.key === 'Backspace') {
                    // Move to previous input on backspace
                     if (index > 0) {
                        otpInputs[index - 1].focus();
                    }
                }
            });
        });

        // --- Forgot Password Logic ---
        
        // Open forgot password modal
        forgotPasswordBtn.addEventListener('click', () => {
            forgotPasswordModal.classList.remove('hidden');
        });

        // Close forgot password modal
        closeForgotModal.addEventListener('click', () => {
            forgotPasswordModal.classList.add('hidden');
            document.getElementById('reset-email').value = '';
        });

        // Close reset password modal
        closeResetModal.addEventListener('click', () => {
            resetPasswordModal.classList.add('hidden');
            resetUserEmail = null;
            resetCode = null;
            resetCodeExpiry = null;
            // Clear form inputs
            document.getElementById('new-password').value = '';
            document.getElementById('confirm-password').value = '';
            const resetCodeInputs = document.querySelectorAll('.reset-code-input');
            resetCodeInputs.forEach(input => input.value = '');
        });

        // Forgot password form submission
        forgotPasswordForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(forgotPasswordForm);
            const email = formData.get('email');
            
            // Check if user exists
            const user = userDB.getUserByEmail(email);
            if (!user) {
                showMessage('error', 'No account found with this email address.');
                return;
            }

            // Generate reset code
            resetCode = generateOTP();
            resetCodeExpiry = new Date(Date.now() + 10 * 60 * 1000); // 10 minutes
            resetUserEmail = email;

            try {
                // Send reset code email
                const emailSent = await sendResetCodeEmail(email, resetCode, user.name);
                
                if (emailSent) {
                    forgotPasswordModal.classList.add('hidden');
                    resetPasswordModal.classList.remove('hidden');
                    showMessage('success', 'Reset code sent to your email!');
                } else {
                    showMessage('error', 'Failed to send reset code. Please try again.');
                }
            } catch (error) {
                console.error('Error sending reset code:', error);
                showMessage('error', 'Failed to send reset code. Please try again.');
            }
        });

        // Reset password form submission
        resetPasswordForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = new FormData(resetPasswordForm);
            const newPassword = formData.get('password');
            const confirmPassword = formData.get('confirmPassword');
            
            // Get reset code from inputs
            const resetCodeInputs = document.querySelectorAll('.reset-code-input');
            const enteredCode = Array.from(resetCodeInputs).map(input => input.value).join('');
            
            // Validate inputs
            if (enteredCode.length !== 6) {
                showMessage('error', 'Please enter the full 6-digit reset code.');
                return;
            }

            if (newPassword.length < 6) {
                showMessage('error', 'Password must be at least 6 characters long.');
                return;
            }

            if (newPassword !== confirmPassword) {
                showMessage('error', 'New password and confirmation password do not match. Please try again.');
                // Clear password fields
                document.getElementById('new-password').value = '';
                document.getElementById('confirm-password').value = '';
                document.getElementById('new-password').focus();
                return;
            }

            if (isResetCodeExpired()) {
                showMessage('error', 'Reset code has expired. Please request a new one.');
                return;
            }

            if (enteredCode !== resetCode) {
                showMessage('error', 'Wrong OTP code. Please check and try again.');
                // Clear reset code inputs
                resetCodeInputs.forEach(input => input.value = '');
                resetCodeInputs[0].focus();
                return;
            }

            // Reset password in database
            const resetResult = userDB.resetPassword(resetUserEmail, newPassword);
            
            if (resetResult.success) {
                showMessage('success', 'Password reset successfully! You can now login with your new password.');
                resetPasswordModal.classList.add('hidden');
                
                // Clear reset data
                resetUserEmail = null;
                resetCode = null;
                resetCodeExpiry = null;
                
                // Clear form inputs
                document.getElementById('new-password').value = '';
                document.getElementById('confirm-password').value = '';
                resetCodeInputs.forEach(input => input.value = '');
                
                // Switch to login tab
                loginTab.click();
            } else {
                showMessage('error', resetResult.message);
            }
        });

        // Resend reset code
        resendResetCodeBtn.addEventListener('click', async () => {
            if (!resetUserEmail) {
                showMessage('error', 'No reset session found. Please start over.');
                return;
            }

            const user = userDB.getUserByEmail(resetUserEmail);
            if (!user) {
                showMessage('error', 'User not found.');
                return;
            }

            // Generate new reset code
            resetCode = generateOTP();
            resetCodeExpiry = new Date(Date.now() + 10 * 60 * 1000);

            try {
                const emailSent = await sendResetCodeEmail(resetUserEmail, resetCode, user.name);
                
                if (emailSent) {
                    showMessage('success', 'New reset code sent successfully!');
                    // Clear reset code inputs
                    const resetCodeInputs = document.querySelectorAll('.reset-code-input');
                    resetCodeInputs.forEach(input => input.value = '');
                    resetCodeInputs[0].focus();
                } else {
                    showMessage('error', 'Failed to send new reset code. Please try again.');
                }
            } catch (error) {
                console.error('Error resending reset code:', error);
                showMessage('error', 'Failed to send new reset code. Please try again.');
            }
        });

        // Reset code input auto-focus logic
        const resetCodeInputs = document.querySelectorAll('.reset-code-input');
        resetCodeInputs.forEach((input, index) => {
            input.addEventListener('keyup', (event) => {
                if (event.key >= 0 && event.key <= 9) {
                    // Move to next input if a number is entered
                    if (index < resetCodeInputs.length - 1) {
                        resetCodeInputs[index + 1].focus();
                    }
                } else if (event.key === 'Backspace') {
                    // Move to previous input on backspace
                    if (index > 0) {
                        resetCodeInputs[index - 1].focus();
                    }
                }
            });
        });

        // Real-time password confirmation validation
        const newPasswordInput = document.getElementById('new-password');
        const confirmPasswordInput = document.getElementById('confirm-password');
        
        function validatePasswordMatch() {
            const newPassword = newPasswordInput.value;
            const confirmPassword = confirmPasswordInput.value;
            
            if (confirmPassword.length > 0) {
                if (newPassword !== confirmPassword) {
                    confirmPasswordInput.style.borderColor = '#ef4444'; // red border
                    confirmPasswordInput.style.backgroundColor = '#fef2f2'; // light red background
                } else {
                    confirmPasswordInput.style.borderColor = '#22c55e'; // green border
                    confirmPasswordInput.style.backgroundColor = '#f0fdf4'; // light green background
                }
            } else {
                confirmPasswordInput.style.borderColor = '#d1d5db'; // default border
                confirmPasswordInput.style.backgroundColor = '#f9fafb'; // default background
            }
        }
        
        newPasswordInput.addEventListener('input', validatePasswordMatch);
        confirmPasswordInput.addEventListener('input', validatePasswordMatch);

        // Helper functions for forgot password
        function isResetCodeExpired() {
            return resetCodeExpiry && new Date() > resetCodeExpiry;
        }

        function sendResetCodeEmail(email, code, userName) {
            const templateParams = {
                to_email: email,
                to_name: userName,
                otp_code: code,
                reset_code: code,
                from_name: 'DeFiLaunch Team',
                reply_to: email,
                message: `Your password reset code is: ${code}. This code will expire in 10 minutes.`
            };

            console.log('Sending reset code email with params:', templateParams);

            return emailjs.send('service_nufodsu', 'template_6d6fjtp', templateParams)
                .then(function(response) {
                    console.log('Reset code email sent successfully!', response.status, response.text);
                    return true;
                }, function(error) {
                    console.error('Failed to send reset code email:', error);
                    return false;
                });
        }

    </script>
</body>
</html>
